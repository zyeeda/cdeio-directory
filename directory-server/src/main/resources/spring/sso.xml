<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:c="http://www.springframework.org/schema/c"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd">
    
    <bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor" />
    
    <bean id="openIdConsumer" class="com.zyeeda.sso.openid.consumer.support.ShiroSessionOpenIdConsumer"
        p:name="${coala.application.name}"
        p:serverProtocol="${coala.server.protocol:http}"
        p:serverAddress="${coala.server.address}"
        p:serverPort="${coala.server.port:80}"
        p:indexPath="${coala.sso.rp.index.path}"
        p:basePath="${coala.sso.rp.base.path}"
        p:providerServerProtocol="${coala.op.server.protocol:http}"
        p:providerServerAddress="${coala.op.server.address}"
        p:providerServerPort="${coala.op.server.port:9100}"
        p:providerBasePath="${coala.sso.op.base.path}" />

    <bean id="shiro" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean"
        p:securityManager-ref="securityManager"
        p:loginUrl="#{openIdConsumer.signInPath}"
        p:successUrl="#{openIdConsumer.indexPath}"
        p:unauthorizedUrl="#{openIdConsumer.signInPath}">
        <property name="filters">
            <util:map>
                <entry key="authc" value-ref="authenticationFilter"/>
                <entry key="signIn" value-ref="signInFilter" />
                <entry key="signOut" value-ref="signOutFilter" />
                <entry key="callback" value-ref="callbackFilter" />
            </util:map>
        </property>
        <property name="filterChainDefinitions">
            <value>
                /accounts/openid/signin = authc, signIn
                /accounts/openid/signout = signOut
                /accounts/openid/verify = authc
                /accounts/openid/callback = authc, callback

                / = authc
                /rest/** = authc
                /invoke/** = authc
            </value>
        </property>
    </bean>

    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager"
        c:singleRealm-ref="openIdConsumerRealm" />

    <bean id="openIdConsumerRealm" class="com.zyeeda.sso.openid.consumer.realm.OpenIdConsumerRealm" />

    <bean id="authenticationFilter" class="com.zyeeda.sso.openid.consumer.web.OpenIdConsumerAuthenticationFilter"
        p:openIdConsumer-ref="openIdConsumer" />

    <bean id="signInFilter" class="com.zyeeda.sso.openid.consumer.web.SignInFilter"
        p:configuration-ref="freemarkerConfiguration"
        p:openIdConsumer-ref="openIdConsumer" />

    <bean id="signOutFilter" class="com.zyeeda.sso.openid.consumer.web.SignOutFilter"
        p:configuration-ref="freemarkerConfiguration"
        p:openIdConsumer-ref="openIdConsumer" />

    <bean id="callbackFilter" class="com.zyeeda.sso.openid.consumer.web.CallbackFilter"
        p:configuration-ref="freemarkerConfiguration" />

</beans>